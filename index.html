<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICT Auto Chart</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

    <style>
        body {
            margin: 0;
            background: #000;
            color: white;
            font-family: Arial;
        }

        .top {
            padding: 10px;
            background: #111;
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        button {
            padding: 8px 14px;
            color: white;
            background: #000;
            border: 1px solid #444;
            border-radius: 5px;
        }

        #chart {
            width: 100%;
            height: calc(100vh - 70px);
        }
    </style>
</head>
<body>

<div class="top">
    <button onclick="loadData('XAUUSD')">XAU/USD</button>
    <button onclick="loadData('XAGUSD')">XAG/USD</button>
    <button onclick="loadData('BTCUSDT')">BTC</button>
    <button onclick="loadData('ETHUSDT')">ETH</button>
</div>

<div id="chart"></div>

<script>
    let chart = LightweightCharts.createChart(document.getElementById('chart'), {
        layout: { background: { color: "#000" }, textColor: "#fff" },
        grid: { vertLines: { color: "#222" }, horzLines: { color: "#222" } },
        timeScale: { timeVisible: true, secondsVisible: false }
    });

    let candleSeries = chart.addCandlestickSeries();
    let fvgBoxes = [];
    let orderBlocks = [];
    let liquidityLines = [];

    async function loadData(symbol) {
        const url = `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=15m&limit=500`;
        const data = await fetch(url).then(r => r.json());

        let candles = data.map(c => ({
            time: c[0] / 1000,
            open: +c[1],
            high: +c[2],
            low: +c[3],
            close: +c[4]
        }));

        candleSeries.setData(candles);

        detectFVG(candles);
        detectOrderBlocks(candles);
        drawLiquidity(candles);
    }

    /* ---------------- AUTO FVG ---------------- */
    function detectFVG(c) {
        fvgBoxes.forEach(b => chart.removeShape(b));
        fvgBoxes = [];

        for (let i = 2; i < c.length; i++) {
            let A = c[i-2], B = c[i-1], C = c[i];

            if (A.high < C.low) {
                let box = chart.addShape({
                    shape: 'box',
                    points: [{ time: A.time, price: A.high }, { time: C.time, price: C.low }],
                    color: "rgba(0,255,0,0.2)",
                    edgeColor: "green"
                });
                fvgBoxes.push(box);
            }

            if (A.low > C.high) {
                let box = chart.addShape({
                    shape: 'box',
                    points: [{ time: A.time, price: A.low }, { time: C.time, price: C.high }],
                    color: "rgba(255,0,0,0.2)",
                    edgeColor: "red"
                });
                fvgBoxes.push(box);
            }
        }
    }

    /* ---------------- AUTO ORDER BLOCK ---------------- */
    function detectOrderBlocks(c) {
        orderBlocks.forEach(b => chart.removeShape(b));
        orderBlocks = [];

        for (let i = 1; i < c.length; i++) {
            let prev = c[i - 1];
            let cur = c[i];

            if (prev.close > prev.open && cur.close < cur.open) {
                let box = chart.addShape({
                    shape: 'box',
                    points: [{ time: prev.time, price: prev.low }, { time: cur.time, price: prev.high }],
                    color: "rgba(255,165,0,0.2)",
                    edgeColor: "orange"
                });
                orderBlocks.push(box);
            }
        }
    }

    /* ---------------- AUTO LIQUIDITY ---------------- */
    function drawLiquidity(c) {
        liquidityLines.forEach(l => chart.removeShape(l));
        liquidityLines = [];

        let highs = c.map(x => x.high);
        let lows = c.map(x => x.low);
        let eqh = Math.max(...highs);
        let eql = Math.min(...lows);

        liquidityLines.push(chart.addShape({
            shape: "line",
            points: [{ time: c[0].time, price: eqh }, { time: c[c.length-1].time, price: eqh }],
            color: "cyan"
        }));

        liquidityLines.push(chart.addShape({
            shape: "line",
            points: [{ time: c[0].time, price: eql }, { time: c[c.length-1].time, price: eql }],
            color: "magenta"
        }));
    }

    loadData("XAUUSD");
</script>

</body>
</html>
